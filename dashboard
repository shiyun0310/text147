<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œåŠå ±åç¾æ³å„€è¡¨æ¿ ğŸ“Š</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šè‡ªè¨‚å­—é«”å’Œä¸»èƒŒæ™¯æ¼¸å±¤ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* é…·ç‚«ç´«è‰²æ¼¸å±¤èƒŒæ™¯ */
            background-color: #4c1d95; /* Fallback color */
            background-image: linear-gradient(to right top, #4c1d95, #7c3aed, #a855f7, #c084fc, #e9d5ff);
            min-height: 100vh;
        }

        /* æ´»æ½‘çš„é™°å½±å’Œå¡ç‰‡æ¨£å¼ */
        .dashboard-card {
            box-shadow: 0 10px 25px -3px rgba(168, 85, 247, 0.3), 0 4px 6px -2px rgba(168, 85, 247, 0.1);
        }
        
        /* å‹•ç•«æ•ˆæœ for åŠ è¼‰ */
        .spinner {
            border-top-color: #a855f7;
            border-left-color: #a855f7;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="w-full max-w-6xl mx-auto bg-white bg-opacity-95 dashboard-card rounded-3xl p-6 md:p-10 my-8">

        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 tracking-tight mb-2">
                æ•™å­¸è¨“ç·´è¨ˆç•«ä¸»æŒäººå·¥ä½œåŠ ğŸ“Š
            </h1>
            <p class="text-lg text-purple-600 font-semibold mt-2">
                å ±åç¾æ³å³æ™‚å„€è¡¨æ¿
            </p>
            <hr class="mt-4 border-2 border-pink-400 w-24 mx-auto rounded-full">
        </header>

        <!-- åŠ è¼‰/éŒ¯èª¤è¨Šæ¯å€å¡Š -->
        <div id="loading-container" class="text-center p-8">
            <div id="loading-spinner" class="spinner w-10 h-10 border-4 border-gray-200 border-solid rounded-full inline-block"></div>
            <p class="mt-4 text-purple-700 font-medium">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
        <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-700 rounded-xl font-semibold">
            âŒ ç„¡æ³•è¼‰å…¥å ±åæ•¸æ“šã€‚è«‹ç¢ºèª Apps Script å·²éƒ¨ç½²ï¼Œä¸¦ä¸”å·²æ›´æ–° `Code.gs` ä¸¦é‡æ–°éƒ¨ç½²ç‚º Web Appï¼
        </div>

        <!-- å„€è¡¨æ¿å…§å®¹å€å¡Š (æˆåŠŸè¼‰å…¥å¾Œé¡¯ç¤º) -->
        <div id="dashboard-content" class="hidden space-y-10">

            <!-- ç¸½è¨ˆ KPI å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-purple-600 text-white p-6 rounded-xl shadow-lg transform hover:scale-[1.02] transition duration-300">
                    <p class="text-sm font-light uppercase opacity-80">ç¸½å ±åäººæ•¸</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="total-registrations" class="text-5xl font-extrabold">0</span>
                        <span class="text-3xl">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
                    </div>
                </div>
                <div class="bg-pink-500 text-white p-6 rounded-xl shadow-lg transform hover:scale-[1.02] transition duration-300">
                    <p class="text-sm font-light uppercase opacity-80">ç¾ä»»è¨ˆç•«ä¸»æŒäºº</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="directors-yes" class="text-4xl font-extrabold">0</span>
                        <span class="text-3xl">ğŸ†</span>
                    </div>
                </div>
                <div class="bg-indigo-500 text-white p-6 rounded-xl shadow-lg transform hover:scale-[1.02] transition duration-300">
                    <p class="text-sm font-light uppercase opacity-80">éè¨ˆç•«ä¸»æŒäºº</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="directors-no" class="text-4xl font-extrabold">0</span>
                        <span class="text-3xl">ğŸ’¡</span>
                    </div>
                </div>
            </div>

            <!-- åƒèˆ‡æ–¹å¼ & è·é¡åˆ†ä½ˆå€å¡Š -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                
                <!-- åƒèˆ‡æ–¹å¼åˆ†ä½ˆ (åœ“é¤…åœ–æ¨¡æ“¬) -->
                <div class="bg-purple-50 p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-purple-800 mb-6 flex items-center">
                        åƒèˆ‡æ–¹å¼åˆ†ä½ˆ ğŸ“
                    </h2>
                    <div id="participation-mode-chart" class="space-y-4">
                        <!-- æ•¸æ“šå°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>

                <!-- è² è²¬è·é¡åˆ†ä½ˆ (é•·æ¢åœ–æ¨¡æ“¬) -->
                <div class="bg-pink-50 p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-pink-700 mb-6 flex items-center">
                        è² è²¬è·é¡äººæ•¸åˆ†ä½ˆ ğŸ¥
                    </h2>
                    <div id="profession-chart" class="space-y-3">
                        <!-- æ•¸æ“šå°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>

            <!-- åŸå§‹æ•¸æ“šè¡¨æ ¼ (å¯é¸ï¼Œç”¨æ–¼ç¢ºèª) -->
            <div class="p-6 bg-gray-50 rounded-2xl shadow-inner">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                    æœ€æ–°å ±ååå–® (å‰ 5 ç­†) ğŸ“‹
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">æ™‚é–“</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">å§“å</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">æ©Ÿæ§‹</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">è·é¡</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">æ–¹å¼</th>
                            </tr>
                        </thead>
                        <tbody id="latest-data-table" class="bg-white divide-y divide-gray-200 text-sm">
                            <!-- æ•¸æ“šå°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </div>

    <script>
        // Apps Script Web App URL (ç”¨æ–¼ GET è«‹æ±‚)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqIp0M_q_3b93tD4pU7OiRveiFlJGydIORqXT_BhMNrkaPQz515P79xppSepMjfeTdFg/exec';

        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-message');
        const dashboardContent = document.getElementById('dashboard-content');

        /**
         * è™•ç†å¾ Apps Script ç²å–åˆ°çš„åŸå§‹è³‡æ–™ï¼Œè¨ˆç®—çµ±è¨ˆæ•¸æ“šã€‚
         * @param {Array} data - å¾ Google Sheets ç²å–çš„å ±åæ•¸æ“šé™£åˆ—ã€‚
         */
        function processDataAndRender(data) {
            const totalCount = data.length;
            
            // 1. è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const stats = {
                total: totalCount,
                director: { 'æ˜¯': 0, 'å¦': 0 },
                participation: { 'å¯¦é«”': 0, 'ç·šä¸Š': 0 },
                profession: {} // è² è²¬çš„è·é¡
            };

            data.forEach(item => {
                // è¨ˆç•«ä¸»æŒäººçµ±è¨ˆ
                const isDirector = item['æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº'] || 'æœªçŸ¥';
                stats.director[isDirector] = (stats.director[isDirector] || 0) + 1;

                // åƒèˆ‡æ–¹å¼çµ±è¨ˆ
                const mode = item['åƒèˆ‡æ–¹å¼'] || 'æœªçŸ¥';
                stats.participation[mode] = (stats.participation[mode] || 0) + 1;

                // è·é¡çµ±è¨ˆ
                const profession = item['è² è²¬çš„è·é¡'] || 'å…¶ä»–';
                stats.profession[profession] = (stats.profession[profession] || 0) + 1;
            });
            
            // 2. æ¸²æŸ“ KPI å¡ç‰‡
            document.getElementById('total-registrations').textContent = totalCount;
            document.getElementById('directors-yes').textContent = stats.director['æ˜¯'] || 0;
            document.getElementById('directors-no').textContent = stats.director['å¦'] || 0;

            // 3. æ¸²æŸ“åƒèˆ‡æ–¹å¼åˆ†ä½ˆ
            renderParticipationChart(stats.participation, totalCount);

            // 4. æ¸²æŸ“è·é¡åˆ†ä½ˆ
            renderProfessionChart(stats.profession, totalCount);
            
            // 5. æ¸²æŸ“æœ€æ–°å ±ååå–® (æœ€è¿‘çš„ 5 ç­†)
            renderLatestDataTable(data.slice(-5).reverse()); // å–æœ€æ–°çš„ 5 ç­†ä¸¦åè½‰ (æœ€æ–°åœ¨æœ€ä¸Šé¢)
            
            // é¡¯ç¤ºå„€è¡¨æ¿å…§å®¹
            loadingContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
        }
        
        /**
         * æ¸²æŸ“åƒèˆ‡æ–¹å¼åˆ†ä½ˆåœ–è¡¨ã€‚
         * @param {Object} participationStats - åƒèˆ‡æ–¹å¼çµ±è¨ˆæ•¸æ“šã€‚
         * @param {number} total - ç¸½äººæ•¸ã€‚
         */
        function renderParticipationChart(participationStats, total) {
            const chartContainer = document.getElementById('participation-mode-chart');
            chartContainer.innerHTML = ''; // æ¸…ç©º
            
            // å®šç¾©é¡è‰²å’Œåœ–æ¨™
            const colors = { 'å¯¦é«”': 'bg-indigo-500', 'ç·šä¸Š': 'bg-pink-500', 'æœªçŸ¥': 'bg-gray-400' };
            const icons = { 'å¯¦é«”': 'ğŸ§‘â€ğŸ¤â€ğŸ§‘', 'ç·šä¸Š': 'ğŸ’»', 'æœªçŸ¥': 'â“' };
            
            Object.keys(participationStats).forEach(mode => {
                const count = participationStats[mode];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                
                const html = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-gray-700 font-semibold flex items-center">${icons[mode]} ${mode} (${count} äºº)</span>
                            <span class="text-sm font-bold text-purple-600">${percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="${colors[mode]} h-3 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
                chartContainer.insertAdjacentHTML('beforeend', html);
            });
        }
        
        /**
         * æ¸²æŸ“è·é¡åˆ†ä½ˆåœ–è¡¨ã€‚
         * @param {Object} professionStats - è·é¡çµ±è¨ˆæ•¸æ“šã€‚
         * @param {number} total - ç¸½äººæ•¸ã€‚
         */
        function renderProfessionChart(professionStats, total) {
            const chartContainer = document.getElementById('profession-chart');
            chartContainer.innerHTML = ''; // æ¸…ç©º
            
            // å°‡è·é¡æ•¸æ“šè½‰æ›ç‚ºé™£åˆ—ä¸¦æŒ‰äººæ•¸é™åºæ’åˆ—
            const sortedProfessions = Object.entries(professionStats).sort(([, a], [, b]) => b - a);
            
            // å®šç¾©ä¸€å€‹éš¨æ©Ÿé¡è‰²ç”Ÿæˆå™¨ (ä»¥ä¿æŒæ´»æ½‘æ€§)
            const colorClasses = [
                'bg-red-400', 'bg-green-400', 'bg-blue-400', 'bg-yellow-400', 
                'bg-purple-400', 'bg-teal-400', 'bg-orange-400', 'bg-cyan-400'
            ];
            
            sortedProfessions.forEach(([profession, count], index) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const color = colorClasses[index % colorClasses.length]; // å¾ªç’°ä½¿ç”¨é¡è‰²
                
                const html = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xs font-semibold w-20 truncate text-gray-700">${profession}</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-4">
                            <div class="${color} h-4 rounded-full flex items-center px-2 text-xs font-bold text-white justify-end" style="width: ${percentage}%">
                                ${count} (${percentage}%)
                            </div>
                        </div>
                    </div>
                `;
                chartContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        /**
         * æ¸²æŸ“æœ€æ–°å ±ååå–®è¡¨æ ¼ã€‚
         * @param {Array} latestData - æœ€æ–°å ±åæ•¸æ“šé™£åˆ—ã€‚
         */
        function renderLatestDataTable(latestData) {
            const tableBody = document.getElementById('latest-data-table');
            tableBody.innerHTML = '';
            
            if (latestData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5" class="px-3 py-2 text-center text-gray-500">ç›®å‰å°šç„¡å ±åè³‡æ–™ã€‚</td></tr>';
                 return;
            }

            latestData.forEach(item => {
                const time = new Date(item['æäº¤æ™‚é–“']).toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', month: '2-digit', day: '2-digit' });
                const row = `
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-800">${time}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-800">${item['å§“å']}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-800">${item['æ©Ÿæ§‹å']}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-800">${item['è² è²¬çš„è·é¡']}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-800 font-semibold ${item['åƒèˆ‡æ–¹å¼'] === 'å¯¦é«”' ? 'text-indigo-600' : 'text-pink-600'}">${item['åƒèˆ‡æ–¹å¼']}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        /**
         * ç²å–æ•¸æ“šã€‚
         */
        async function fetchData() {
            loadingContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            dashboardContent.classList.add('hidden');

            try {
                // ä½¿ç”¨ Apps Script çš„ GET è«‹æ±‚ä¾†ç²å–æ•¸æ“š
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'GET',
                    cache: 'no-cache'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    processDataAndRender(result.data);
                } else {
                    errorContainer.innerHTML = `âŒ è¼‰å…¥å¤±æ•—ï¼š${result.message || 'Apps Script åŸ·è¡ŒéŒ¯èª¤ã€‚'}`;
                    errorContainer.classList.remove('hidden');
                    loadingContainer.classList.add('hidden');
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                errorContainer.classList.remove('hidden');
                loadingContainer.classList.add('hidden');
            }
        }

        // é é¢è¼‰å…¥å¾Œç«‹å³ç²å–æ•¸æ“š
        window.onload = fetchData;
        
        // è¨­å®šæ¯ 30 ç§’è‡ªå‹•æ›´æ–°æ•¸æ“š
        setInterval(fetchData, 30000); 

    </script>
</body>
</html>
